# Automatic Blog Post Publishing for Vercel
# Publishes 1 scheduled post per day at 9:00 AM Toronto (14:00 UTC)
# Posts are scheduled via article:published_time meta tag
# Commits changes to GitHub, Vercel auto-deploys

name: Auto-Publish Blog Posts

on:
  schedule:
    # Daily at 9:00 AM Toronto = 14:00 UTC
    # Note: Toronto is EST (UTC-5) in winter, EDT (UTC-4) in summer
    # Using 14:00 UTC which is 9 AM EST (winter) or 10 AM EDT (summer)
    - cron: '0 14 * * *'

  workflow_dispatch:  # Allow manual triggering from GitHub UI

jobs:
  publish-posts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for scheduled posts
        id: check-posts
        run: |
          echo "Checking for posts scheduled for today..."
          python scripts/auto-publish-posts.py --dry-run --count 1

      - name: Publish scheduled post
        run: |
          python scripts/auto-publish-posts.py --count 1

      - name: Update sitemap
        run: |
          python scripts/update-sitemap.py

      - name: Update blog index
        run: |
          python scripts/update-blog-index.py

      - name: Commit and push changes to GitHub
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions Bot"
          git add -A

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "[INFO] No posts scheduled for today or already published"
            exit 0
          else
            TODAY=$(date +%Y-%m-%d)
            git commit -m "Auto-publish: Blog post for $TODAY

            - Timestamp: $(date)
            - Trigger: Daily schedule (9 AM Toronto)
            - Source: GitHub Actions

            Vercel will auto-deploy this commit."
            git push
            echo "[SUCCESS] Changes pushed to GitHub - Vercel will deploy"
          fi

      - name: Notify on Slack (Optional)
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "Blog post published - Check Vercel deployment",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Blog Auto-Publishing*\nDate: $(date +%Y-%m-%d)\nStatus: Posted"
                  }
                }
              ]
            }
        continue-on-error: true
